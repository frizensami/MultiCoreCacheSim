<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SimulatorCore</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><a href="Trace.html"><span class="hs-identifier">Trace</span></a><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><a href="Processor.html"><span class="hs-identifier">Processor</span></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><a href="Bus.html"><span class="hs-identifier">Bus</span></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><a href="Definitions.html"><span class="hs-identifier">Definitions</span></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="Utility.html"><span class="hs-identifier">Utility</span></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Debug</span><span class="hs-operator">.</span><span class="hs-identifier">Trace</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="Statistics.html"><span class="hs-identifier">Statistics</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Memory.html"><span class="hs-identifier">Memory</span></a><span> </span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-comment">-- Defining constants</span><span>
</span><a name="line-16"></a><span class="hs-identifier">num_processors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-17"></a><a name="num_processors"><a href="SimulatorCore.html#num_processors"><span class="hs-identifier">num_processors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-comment">-- |Given appropriate cmd line arguments, runs the entire cache simulation and results the stats results</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Reads in all traces and kicks off the pure part of this simulation</span><span>
</span><a name="line-21"></a><span class="hs-identifier">runSimulation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Definitions.html#ProtocolInput"><span class="hs-identifier hs-type">ProtocolInput</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Definitions.html#Filename"><span class="hs-identifier hs-type">Filename</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Definitions.html#CacheSize"><span class="hs-identifier hs-type">CacheSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Definitions.html#Associativity"><span class="hs-identifier hs-type">Associativity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Definitions.html#BlockSize"><span class="hs-identifier hs-type">BlockSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Definitions.html#StatsReport"><span class="hs-identifier hs-type">StatsReport</span></a><span>
</span><a name="line-22"></a><a name="runSimulation"><a href="SimulatorCore.html#runSimulation"><span class="hs-identifier">runSimulation</span></a></a><span> </span><a name="local-6989586621679048323"><a href="#local-6989586621679048323"><span class="hs-identifier">protocolInput</span></a></a><span> </span><a name="local-6989586621679048324"><a href="#local-6989586621679048324"><span class="hs-identifier">fileName</span></a></a><span> </span><a name="local-6989586621679048325"><a href="#local-6989586621679048325"><span class="hs-identifier">cacheSize</span></a></a><span> </span><a name="local-6989586621679048326"><a href="#local-6989586621679048326"><span class="hs-identifier">associativity</span></a></a><span> </span><a name="local-6989586621679048327"><a href="#local-6989586621679048327"><span class="hs-identifier">blockSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-23"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-24"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>            </span><span class="hs-comment">-- Parse the protocol</span><span>
</span><a name="line-27"></a><span>            </span><span class="hs-comment">-- Possible error with read here if bad input given</span><span>
</span><a name="line-28"></a><span>            </span><a name="local-6989586621679048328"><a href="#local-6989586621679048328"><span class="hs-identifier">protocol</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><a href="#local-6989586621679048323"><span class="hs-identifier hs-var">protocolInput</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Definitions.html#Protocol"><span class="hs-identifier hs-type">Protocol</span></a><span> </span><span>
</span><a name="line-29"></a><span>            </span><span>
</span><a name="line-30"></a><span>            </span><span class="hs-comment">-- Read the input files</span><span>
</span><a name="line-31"></a><span>            </span><span class="hs-comment">-- Create exactly 4 trace files names</span><span>
</span><a name="line-32"></a><span>            </span><a name="local-6989586621679048329"><a href="#local-6989586621679048329"><span class="hs-identifier">fileNames</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679048335"><a href="#local-6989586621679048335"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679048324"><span class="hs-identifier hs-var">fileName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679048335"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.data&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><a href="SimulatorCore.html#num_processors"><span class="hs-identifier hs-var">num_processors</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>            </span><span class="hs-comment">-- Create a set of strings, each will lazily read from the file as needed (IO [String]])</span><span>
</span><a name="line-35"></a><span>            </span><a name="local-6989586621679048330"><a href="#local-6989586621679048330"><span class="hs-identifier">fileStrings</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readFile</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048329"><span class="hs-identifier hs-var">fileNames</span></a><span> </span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>            </span><span class="hs-comment">-- Read the list of strings from the file read process into a list of list of lines</span><span>
</span><a name="line-38"></a><span>            </span><span class="hs-comment">-- Each element of the list is a list of the lines from a single file</span><span>
</span><a name="line-39"></a><span>            </span><span class="hs-comment">-- liftM applies this composed &amp; curried function into the list monad</span><span>
</span><a name="line-40"></a><span>            </span><a name="local-6989586621679048331"><a href="#local-6989586621679048331"><span class="hs-identifier">fileLines</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">lines</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048330"><span class="hs-identifier hs-var">fileStrings</span></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span>            </span><span class="hs-comment">-- Map each of these lines to a trace</span><span>
</span><a name="line-43"></a><span>            </span><span class="hs-comment">-- This is now of type IO [[Trace]] where each outer list element is one processor</span><span>
</span><a name="line-44"></a><span>            </span><span class="hs-comment">-- and the inner lists are the traces for that processor</span><span>
</span><a name="line-45"></a><span>            </span><a name="local-6989586621679048332"><a href="#local-6989586621679048332"><span class="hs-identifier">tracesIO</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span class="hs-special">)</span><span> </span><a href="Trace.html#toTraceWithError"><span class="hs-identifier hs-var">toTraceWithError</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048331"><span class="hs-identifier hs-var">fileLines</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>            </span><span class="hs-comment">-- Initialize as many processors as we need in their initial states</span><span>
</span><a name="line-48"></a><span>            </span><span>
</span><a name="line-49"></a><span>            </span><a name="local-6989586621679048333"><a href="#local-6989586621679048333"><span class="hs-identifier">newProcessorWithoutID</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Processor.html#createProcessor"><span class="hs-identifier hs-var">Processor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">createProcessor</span></a><span> </span><a href="#local-6989586621679048323"><span class="hs-identifier hs-var">protocolInput</span></a><span> </span><a href="#local-6989586621679048325"><span class="hs-identifier hs-var">cacheSize</span></a><span> </span><a href="#local-6989586621679048326"><span class="hs-identifier hs-var">associativity</span></a><span> </span><a href="#local-6989586621679048327"><span class="hs-identifier hs-var">blockSize</span></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>            </span><a name="local-6989586621679048334"><a href="#local-6989586621679048334"><span class="hs-identifier">processorsList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679048333"><span class="hs-identifier hs-var">newProcessorWithoutID</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><a href="SimulatorCore.html#num_processors"><span class="hs-identifier hs-var">num_processors</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>        </span><span class="hs-comment">-- Get the entire list of pure traces from the IO [[Trace]] structure</span><span>
</span><a name="line-54"></a><span>        </span><a name="local-6989586621679048810"><a href="#local-6989586621679048810"><span class="hs-identifier">tracesList</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679048332"><span class="hs-identifier hs-var">tracesIO</span></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>        </span><span class="hs-comment">-- Run the pure section of the simulation (end of impure code, start of actual sim)</span><span>
</span><a name="line-57"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679048811"><a href="#local-6989586621679048811"><span class="hs-identifier">statsReport</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimulatorCore.html#startSimulationPure"><span class="hs-identifier hs-var">startSimulationPure</span></a><span> </span><a href="#local-6989586621679048334"><span class="hs-identifier hs-var">processorsList</span></a><span> </span><a href="#local-6989586621679048810"><span class="hs-identifier hs-var">tracesList</span></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>        </span><span class="hs-comment">-- Now run one round of the simulation loop and see if a core needs another instruction</span><span>
</span><a name="line-60"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679048811"><span class="hs-identifier hs-var">statsReport</span></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- General idea: for each processor, execute the new trace if there is one, or continue with current action. Then, propagate the bus events to ALL OTHER PROCESSORS: aka all other processors MUST RESPOND to the bus event before this processors' CYCLE is over. Then, repeat for the rest. Check when more awake whether this makes sense. Therefore, processor 1 always has priority, followed by 2...etc. Deterministic</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- Morning note: this makes sense. It's almost like each processor is running sequentially with a particular priority on each cycle, which could happen in a particularly biased computer.</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- |Runs a single cycle for a single processor. Attempts to feed it a list of traces. The processor may consume some part of the list of traces, then return a new Processor instance (the new processor state essentially), the remaining traces to be consumed, and a list of bus events generated by this processor</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- runOneProcessorCycle :: Processor -&gt; [Trace] -&gt; (Processor, [Trace], [Message])</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- runOneProcessorCycle processor tracexs = </span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- |Start of the pure part of the code - the IO for the traces has been unwrapped in runSimulation</span><span>
</span><a name="line-70"></a><span class="hs-identifier">startSimulationPure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Definitions.html#StatsReport"><span class="hs-identifier hs-type">StatsReport</span></a><span>
</span><a name="line-71"></a><a name="startSimulationPure"><a href="SimulatorCore.html#startSimulationPure"><span class="hs-identifier">startSimulationPure</span></a></a><span> </span><a name="local-6989586621679048812"><a href="#local-6989586621679048812"><span class="hs-identifier">processorsList</span></a></a><span> </span><a name="local-6989586621679048813"><a href="#local-6989586621679048813"><span class="hs-identifier">tracesList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-73"></a><span>        </span><span class="hs-comment">-- processorTraceList :: [(Processor, [Trace])]</span><span>
</span><a name="line-74"></a><span>        </span><a name="local-6989586621679048814"><a href="#local-6989586621679048814"><span class="hs-identifier">processorTraceList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679048812"><span class="hs-identifier hs-var">processorsList</span></a><span> </span><a href="#local-6989586621679048813"><span class="hs-identifier hs-var">tracesList</span></a><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- Create the bus queue</span><span>
</span><a name="line-76"></a><span>        </span><a name="local-6989586621679048815"><a href="#local-6989586621679048815"><span class="hs-identifier">eventBus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bus.html#createNewCacheEventBus"><span class="hs-identifier hs-var">createNewCacheEventBus</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">getCache</span><span> </span><a href="#local-6989586621679048812"><span class="hs-identifier hs-var">processorsList</span></a><span class="hs-special">)</span><span> </span><a href="Memory.html#create"><span class="hs-identifier hs-var">Memory</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-77"></a><span>        </span><span class="hs-comment">-- For each processor, we need to </span><span>
</span><a name="line-78"></a><span>        </span><span class="hs-comment">-- 1. Attempt to run one trace</span><span>
</span><a name="line-79"></a><span>        </span><span class="hs-comment">-- 2. Send their generated messages to all other processes</span><span>
</span><a name="line-80"></a><span>        </span><span class="hs-comment">-- 3. Propagate all messages </span><span>
</span><a name="line-81"></a><span>        </span><a name="local-6989586621679048816"><a href="#local-6989586621679048816"><span class="hs-identifier">report</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimulatorCore.html#runAllSimulationCycles"><span class="hs-identifier hs-var">runAllSimulationCycles</span></a><span> </span><a href="#local-6989586621679048814"><span class="hs-identifier hs-var">processorTraceList</span></a><span> </span><a href="#local-6989586621679048815"><span class="hs-identifier hs-var">eventBus</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-82"></a><span>        </span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-string">&quot;----Simulation Complete----\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679048816"><span class="hs-identifier hs-var">report</span></a><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">-- |Pass in the processors and traces, tbe index of the current processor being worked on, and the number of cycles completed.</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- |Eventually the statistics report will be returned</span><span>
</span><a name="line-87"></a><span class="hs-identifier">runAllSimulationCycles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bus.html#CacheEventBus"><span class="hs-identifier hs-type">CacheEventBus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Statistics.html#SimulationStatistics"><span class="hs-identifier hs-type">SimulationStatistics</span></a><span>
</span><a name="line-88"></a><a name="runAllSimulationCycles"><a href="SimulatorCore.html#runAllSimulationCycles"><span class="hs-identifier">runAllSimulationCycles</span></a></a><span> </span><a name="local-6989586621679048817"><a href="#local-6989586621679048817"><span class="hs-identifier">processorTraceList</span></a></a><span> </span><a name="local-6989586621679048818"><a href="#local-6989586621679048818"><span class="hs-identifier">eventBus</span></a></a><span> </span><a name="local-6989586621679048819"><a href="#local-6989586621679048819"><span class="hs-identifier">processorIndex</span></a></a><span> </span><a name="local-6989586621679048820"><a href="#local-6989586621679048820"><span class="hs-identifier">numCyclesCompleted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-comment">-- Run this simulation for all 4 processors then increment the cycle counter</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-comment">-- Get the current processor to be operated on, and the rest of the list</span><span>
</span><a name="line-92"></a><span>        </span><a name="local-6989586621679048821"><a href="#local-6989586621679048821"><span class="hs-identifier">currentProcessorTrace</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679048817"><span class="hs-identifier hs-var">processorTraceList</span></a><span class="hs-operator hs-var">!!</span><a href="#local-6989586621679048819"><span class="hs-identifier hs-var">processorIndex</span></a><span>
</span><a name="line-93"></a><span>        </span><a name="local-6989586621679048822"><a href="#local-6989586621679048822"><span class="hs-identifier">restOfProcessors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Utility.html#removeNthElement"><span class="hs-identifier hs-var">removeNthElement</span></a><span> </span><a href="#local-6989586621679048817"><span class="hs-identifier hs-var">processorTraceList</span></a><span> </span><a href="#local-6989586621679048819"><span class="hs-identifier hs-var">processorIndex</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-comment">-- RECONSTRUCT EVENT BUS EVERY CYCLE WITH CACHES OF ALL PROCESSORS to keep it updated</span><span>
</span><a name="line-96"></a><span>        </span><a name="local-6989586621679048823"><a href="#local-6989586621679048823"><span class="hs-identifier">eventBus'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bus.html#recreateCacheEventBus"><span class="hs-identifier hs-var">recreateCacheEventBus</span></a><span> </span><a href="#local-6989586621679048818"><span class="hs-identifier hs-var">eventBus</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getCache</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048817"><span class="hs-identifier hs-var">processorTraceList</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">-- Run a single processor cycle</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679048824"><a href="#local-6989586621679048824"><span class="hs-identifier">newProcessor</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679048825"><a href="#local-6989586621679048825"><span class="hs-identifier">restOfTraces</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679048826"><a href="#local-6989586621679048826"><span class="hs-identifier">newBus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimulatorCore.html#runOneProcessorCycle"><span class="hs-identifier hs-var">runOneProcessorCycle</span></a><span> </span><a href="#local-6989586621679048821"><span class="hs-identifier hs-var">currentProcessorTrace</span></a><span> </span><a href="#local-6989586621679048823"><span class="hs-identifier hs-var">eventBus'</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- Insert the modified processor back into the list of processors</span><span>
</span><a name="line-102"></a><span>        </span><a name="local-6989586621679048827"><a href="#local-6989586621679048827"><span class="hs-identifier">newProcessorTraceList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Utility.html#insertElementAtIdx"><span class="hs-identifier hs-var">insertElementAtIdx</span></a><span> </span><a href="#local-6989586621679048822"><span class="hs-identifier hs-var">restOfProcessors</span></a><span> </span><a href="#local-6989586621679048819"><span class="hs-identifier hs-var">processorIndex</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048824"><span class="hs-identifier hs-var">newProcessor</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679048825"><span class="hs-identifier hs-var">restOfTraces</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>        </span><span class="hs-comment">-- Consider if we need to re-create the bus here after this processor is complete</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-comment">-- No need if we dont' do anything with the bus till next run of this function</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-comment">-- SPECIAL CASE: IF WE HAVE FINISHED ALL PROCESSORS FOR THIS CYCLE - RUN THE EVENT BUS</span><span>
</span><a name="line-108"></a><span>        </span><span class="hs-comment">-- (newProcessorTraceList', newBus') = </span><span>
</span><a name="line-109"></a><span>        </span><span class="hs-comment">--    if processorIndex == (num_processors - 1)</span><span>
</span><a name="line-110"></a><span>        </span><span class="hs-comment">--        then executeEventBus newProcessorTraceList eventBus</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-comment">--        else (newProcessorTraceList, newBus)</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- Define the cycle and processor number arguments for the next recursive call</span><span>
</span><a name="line-114"></a><span>        </span><a name="local-6989586621679048828"><a href="#local-6989586621679048828"><span class="hs-identifier">newProcessorIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048819"><span class="hs-identifier hs-var">processorIndex</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><a href="SimulatorCore.html#num_processors"><span class="hs-identifier hs-var">num_processors</span></a><span>
</span><a name="line-115"></a><span>        </span><a name="local-6989586621679048829"><a href="#local-6989586621679048829"><span class="hs-identifier">newNumCyclesCompleted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679048828"><span class="hs-identifier hs-var">newProcessorIndex</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679048820"><span class="hs-identifier hs-var">numCyclesCompleted</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679048820"><span class="hs-identifier hs-var">numCyclesCompleted</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="SimulatorCore.html#allProcessorsComplete"><span class="hs-identifier hs-var">allProcessorsComplete</span></a><span> </span><a href="#local-6989586621679048817"><span class="hs-identifier hs-var">processorTraceList</span></a><span>
</span><a name="line-118"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">trace</span><span> </span><span class="hs-string">&quot;Simulation complete: getting stats&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span>
</span><a name="line-119"></a><span>                         </span><a href="SimulatorCore.html#getStatsReport"><span class="hs-identifier hs-var">getStatsReport</span></a><span> </span><a href="#local-6989586621679048817"><span class="hs-identifier hs-var">processorTraceList</span></a><span> </span><a href="#local-6989586621679048820"><span class="hs-identifier hs-var">numCyclesCompleted</span></a><span>
</span><a name="line-120"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">trace</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;runAllSimulationCycles pid=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679048828"><span class="hs-identifier hs-var">newProcessorIndex</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: Cycles Completed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679048829"><span class="hs-identifier hs-var">newNumCyclesCompleted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SimulatorCore.html#runAllSimulationCycles"><span class="hs-identifier hs-var">runAllSimulationCycles</span></a><span> </span><a href="#local-6989586621679048827"><span class="hs-identifier hs-var">newProcessorTraceList</span></a><span> </span><a href="#local-6989586621679048826"><span class="hs-identifier hs-var">newBus</span></a><span> </span><a href="#local-6989586621679048828"><span class="hs-identifier hs-var">newProcessorIndex</span></a><span> </span><a href="#local-6989586621679048829"><span class="hs-identifier hs-var">newNumCyclesCompleted</span></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span>    </span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- |Attempts to feed one trace to the processor, which it can avoid consuming if it's already working on something/busy</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- Returns a new processor with updated state, the remaining traces to execute, and any new bus events to propagate</span><span>
</span><a name="line-126"></a><span class="hs-identifier">runOneProcessorCycle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bus.html#CacheEventBus"><span class="hs-identifier hs-type">CacheEventBus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Bus.html#CacheEventBus"><span class="hs-identifier hs-type">CacheEventBus</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><a name="runOneProcessorCycle"><a href="SimulatorCore.html#runOneProcessorCycle"><span class="hs-identifier">runOneProcessorCycle</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679048830"><a href="#local-6989586621679048830"><span class="hs-identifier">processor</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679048831"><a href="#local-6989586621679048831"><span class="hs-identifier">allTraces</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679048832"><a href="#local-6989586621679048832"><span class="hs-identifier">oneTrace</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679048833"><a href="#local-6989586621679048833"><span class="hs-identifier">restOfTraces</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679048834"><a href="#local-6989586621679048834"><span class="hs-identifier">eventBus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621679048835"><span class="hs-identifier hs-var">newProcessor</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679048838"><span class="hs-identifier hs-var">traces</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679048837"><span class="hs-identifier hs-var">newBus</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679048835"><a href="#local-6989586621679048835"><span class="hs-identifier">newProcessor</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679048836"><a href="#local-6989586621679048836"><span class="hs-identifier">hasConsumedTrace</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679048837"><a href="#local-6989586621679048837"><span class="hs-identifier">newBus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Processor.html#runOneCycle"><span class="hs-identifier hs-var">Processor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">runOneCycle</span></a><span> </span><a href="#local-6989586621679048830"><span class="hs-identifier hs-var">processor</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679048832"><span class="hs-identifier hs-var">oneTrace</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048834"><span class="hs-identifier hs-var">eventBus</span></a><span>
</span><a name="line-131"></a><span>        </span><a name="local-6989586621679048838"><a href="#local-6989586621679048838"><span class="hs-identifier">traces</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679048836"><span class="hs-identifier hs-var">hasConsumedTrace</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679048833"><span class="hs-identifier hs-var">restOfTraces</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679048831"><span class="hs-identifier hs-var">allTraces</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-identifier">runOneProcessorCycle</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679048839"><a href="#local-6989586621679048839"><span class="hs-identifier">processor</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679048840"><a href="#local-6989586621679048840"><span class="hs-identifier">eventBus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621679048841"><span class="hs-identifier hs-var">newProcessor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679048842"><span class="hs-identifier hs-var">newBus</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679048841"><a href="#local-6989586621679048841"><span class="hs-identifier">newProcessor</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679048842"><a href="#local-6989586621679048842"><span class="hs-identifier">newBus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Processor.html#runOneCycle"><span class="hs-identifier hs-var">Processor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">runOneCycle</span></a><span> </span><a href="#local-6989586621679048839"><span class="hs-identifier hs-var">processor</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679048840"><span class="hs-identifier hs-var">eventBus</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- TO BE IMPLEMENTED: Check if all processors are DONE. Now just checks that all traces are consumed. </span><span>
</span><a name="line-139"></a><span class="hs-comment">-- Perhaps this is sufficient?</span><span>
</span><a name="line-140"></a><span class="hs-identifier">allProcessorsComplete</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-141"></a><a name="allProcessorsComplete"><a href="SimulatorCore.html#allProcessorsComplete"><span class="hs-identifier">allProcessorsComplete</span></a></a><span> </span><a name="local-6989586621679048843"><a href="#local-6989586621679048843"><span class="hs-identifier">processorTraceList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048843"><span class="hs-identifier hs-var">processorTraceList</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- TO BE IMPLEMETED</span><span>
</span><a name="line-144"></a><span class="hs-identifier">getStatsReport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Processor.html#Processor"><span class="hs-identifier hs-type">Processor</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Trace.html#Trace"><span class="hs-identifier hs-type">Trace</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Statistics.html#SimulationStatistics"><span class="hs-identifier hs-type">SimulationStatistics</span></a><span>
</span><a name="line-145"></a><a name="getStatsReport"><a href="SimulatorCore.html#getStatsReport"><span class="hs-identifier">getStatsReport</span></a></a><span> </span><a name="local-6989586621679048844"><a href="#local-6989586621679048844"><span class="hs-identifier">processorTraceList</span></a></a><span> </span><a name="local-6989586621679048845"><a href="#local-6989586621679048845"><span class="hs-identifier">totalCycles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-147"></a><span>        </span><a name="local-6989586621679048846"><a href="#local-6989586621679048846"><span class="hs-identifier">processorStatsList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getProcessorStatistics</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679048844"><span class="hs-identifier hs-var">processorTraceList</span></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Statistics.html#SimulationStatistics"><span class="hs-identifier hs-var">SimulationStatistics</span></a><span> </span><a href="#local-6989586621679048845"><span class="hs-identifier hs-var">totalCycles</span></a><span> </span><a href="#local-6989586621679048846"><span class="hs-identifier hs-var">processorStatsList</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- TO BE IMPLEMENTED</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- executeEventBus :: [(Processor, [Trace])] -&gt; CacheEventBus -&gt; ([(Processor, [Trace])], CacheEventBus)</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- executeEventBus processorTraceList eventBus = (processorTraceList, eventBus)-- error &quot;TBI&quot;</span><span>
</span><a name="line-153"></a></pre></body></html>